name: Build & Test (.NET 9)

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

env:
  DOTNET_VERSION: "9.x"
  SOLUTION_FILE: "CleanArchitecture.sln"

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_FILE }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_FILE }} --configuration Release --no-restore


  # ------------------------------------------------------------
  # 🧪 Tests Unitaires – Avec TRX
  # ------------------------------------------------------------
  unit_tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run Unit Tests (xUnit only)
        run: |
          dotnet test tests/FunctionalTests/Api.FunctionalTests/Api.FunctionalTests.csproj \
            --configuration Release \
            --no-build \
            --logger trx \
            --results-directory TestResults

      - name: Upload TRX Test Results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: TestResults


  # ------------------------------------------------------------
  # 🧱 Tests d’Architecture – Sans TRX
  # ------------------------------------------------------------
  architecture_tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run Architecture Tests (No TRX)
        run: |
          dotnet test tests/ArchitectureTests/ArchitectureTests.csproj \
            --configuration Release \
            --no-build


  # ------------------------------------------------------------
  # 🚀 Publication (seulement en workflow_dispatch)
  # ------------------------------------------------------------
  publish:
    runs-on: ubuntu-latest
    needs: [unit_tests, architecture_tests]
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish Application
        run: |
          dotnet publish ${{ env.SOLUTION_FILE }} \
            --configuration Release \
            --no-build \
            --output ./published

      - name: Upload Published App
        uses: actions/upload-artifact@v4
        with:
          name: published-app
          path: published
